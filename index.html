import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp } from 'firebase/firestore';
import { Camera, Plus, Trash2, Cloud, Calculator, ChevronRight, AlertCircle, CheckCircle2, Loader2 } from 'lucide-react';

// Firebase 초기 설정 (환경 변수 사용)
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'grade-strategy-beta';

export default function App() {
  const [user, setUser] = useState(null);
  const [studentName, setStudentName] = useState('');
  const [gradeLevel, setGradeLevel] = useState('3'); // 3: 9등급, 1: 5등급
  const [subjects, setSubjects] = useState([{ id: Date.now(), name: '국어', achieve: 'A', rank: '', total: '' }]);
  const [analysis, setAnalysis] = useState(null);
  const [history, setHistory] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [modal, setModal] = useState({ show: false, title: '', desc: '', theme: 'indigo' });
  
  // 무료 사용자 제한을 위한 상태 (간이 쿨타임)
  const [lastRequestTime, setLastRequestTime] = useState(0);

  const CUTOFFS = { '9': [0.04, 0.11, 0.23, 0.40, 0.60, 0.77, 0.89, 0.96, 1.00], '5': [0.10, 0.34, 0.66, 0.90, 1.00] };

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'history');
    const unsubscribe = onSnapshot(q, (snap) => {
      const items = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.timestamp - a.timestamp);
      setHistory(items);
    });
    return () => unsubscribe();
  }, [user]);

  const showToast = (title, desc, theme = 'indigo') => {
    setModal({ show: true, title, desc, theme });
    setTimeout(() => setModal(prev => ({ ...prev, show: false })), 3000);
  };

  const addSubjectRow = () => {
    setSubjects([...subjects, { id: Date.now(), name: '', achieve: 'A', rank: '', total: '' }]);
  };

  const handleScan = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // [제한 1] 파일 크기 제한 (무료 API 부하 방지 - 4MB 이하)
    if (file.size > 4 * 1024 * 1024) {
      showToast("제한됨", "이미지 크기는 4MB를 넘을 수 없습니다.", "rose");
      e.target.value = '';
      return;
    }

    // [제한 2] 요청 쿨타임 (무료 RPM 15회 고려 - 10초 내 재요청 방지)
    const now = Date.now();
    if (now - lastRequestTime < 10000) {
      showToast("대기 중", "분석 요청은 10초에 한 번만 가능합니다.", "rose");
      e.target.value = '';
      return;
    }

    setIsLoading(true);
    setLastRequestTime(now);

    try {
      const base64 = await new Promise(r => {
        const reader = new FileReader();
        reader.onload = () => r(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
      });

      const prompt = `성적표 이미지에서 학생명과 과목별 [과목명, 성취도, 석차, 수강자수]를 추출하여 JSON 형식으로 응답해줘. JSON 구조: {"studentName": "이름", "subjects": [{"name": "과목명", "achieve": "A", "rank": 10, "total": 200}]}`;
      
      const response = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }],
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      // [제한 3] API 사용량 초과(429) 또는 서버 에러 처리
      if (response.status === 429) {
        throw new Error("RATE_LIMIT");
      }
      if (!response.ok) throw new Error("PROXY_ERROR");

      const result = await response.json();
      const data = JSON.parse(result.candidates[0].content.parts[0].text);

      if (data.studentName) setStudentName(data.studentName);
      if (data.subjects) {
        setSubjects(data.subjects.map(s => ({ ...s, id: Math.random() })));
      }
      showToast("인식 성공", "성적표 데이터를 성공적으로 가져왔습니다.", "emerald");
    } catch (err) {
      if (err.message === "RATE_LIMIT") {
        showToast("사용량 초과", "현재 서버 요청이 너무 많습니다. 잠시 후 다시 시도하세요.", "rose");
      } else {
        showToast("인식 실패", "이미지를 분석할 수 없습니다. 프록시 서버 설정을 확인하세요.", "rose");
      }
    } finally {
      setIsLoading(false);
      e.target.value = '';
    }
  };

  const calculate = () => {
    const cuts = CUTOFFS[gradeLevel];
    let data = [];
    
    subjects.forEach(s => {
      const rank = parseInt(s.rank);
      const total = parseInt(s.total);
      if (s.name && rank && total) {
        const ratio = rank / total;
        let grade = cuts.length;
        for (let i = 0; i < cuts.length; i++) {
          if (ratio <= cuts[i]) { grade = i + 1; break; }
        }
        
        let target = null;
        if (grade > 1) {
          const nextCut = cuts[grade - 2];
          const nextRank = Math.floor(total * nextCut);
          target = { grade: grade - 1, diff: rank - nextRank, nextRank };
        }
        data.push({ ...s, grade, ratio, target });
      }
    });

    if (data.length === 0) return showToast("데이터 없음", "과목 정보를 입력해주세요.", "slate");

    const avg = (data.reduce((sum, c) => sum + c.grade, 0) / data.length).toFixed(2);
    setAnalysis({ avg, subjects: data });
  };

  const saveToCloud = async () => {
    if (!user || !analysis) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), {
        studentName,
        gradeLevel,
        avgGrade: analysis.avg,
        subjects: analysis.subjects,
        timestamp: serverTimestamp()
      });
      showToast("저장 완료", "클라우드에 안전하게 저장되었습니다.", "emerald");
    } catch (e) {
      showToast("저장 실패", "데이터베이스 연결 오류", "rose");
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-20">
      {/* Navigation */}
      <nav className="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div className="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-black shadow-lg">G</div>
            <span className="font-black text-xl tracking-tight">GradeStrategy.ai</span>
          </div>
          <button onClick={saveToCloud} className="text-xs font-bold bg-slate-900 text-white px-4 py-2 rounded-full hover:bg-slate-800 transition-all flex items-center gap-2">
            <Cloud size={14} /> 기록 저장
          </button>
        </div>
      </nav>

      <main className="max-w-6xl mx-auto px-6 pt-10">
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-10">
          {/* Left Column: Input */}
          <div className="lg:col-span-5 space-y-6">
            <div className="bg-white rounded-[2.5rem] p-8 shadow-xl shadow-slate-200/60 border border-slate-100">
              <h2 className="text-2xl font-black mb-2">성적 데이터 분석</h2>
              <div className="flex items-center gap-2 mb-8">
                <span className="bg-slate-100 text-[10px] px-2 py-1 rounded-md font-bold text-slate-500">Free Tier</span>
                <p className="text-slate-500 text-sm">성적표를 스캔하여 전략을 세우세요.</p>
              </div>

              <div className="grid grid-cols-2 gap-4 mb-8">
                <div className="space-y-1">
                  <label className="text-[10px] font-black text-slate-400 ml-1 uppercase">Student Name</label>
                  <input value={studentName} onChange={e => setStudentName(e.target.value)} type="text" placeholder="이름" className="w-full bg-slate-50 rounded-2xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-indigo-500/20 outline-none border-none" />
                </div>
                <div className="space-y-1">
                  <label className="text-[10px] font-black text-slate-400 ml-1 uppercase">System</label>
                  <select value={gradeLevel} onChange={e => setGradeLevel(e.target.value)} className="w-full bg-slate-50 rounded-2xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-indigo-500/20 outline-none border-none">
                    <option value="3">고등 9등급제</option>
                    <option value="1">개정 5등급제</option>
                  </select>
                </div>
              </div>

              <div className="flex gap-3 mb-8">
                <label className={`flex-1 cursor-pointer bg-indigo-600 text-white px-4 py-4 rounded-2xl text-sm font-black text-center shadow-lg flex items-center justify-center gap-2 hover:bg-indigo-700 transition-all ${isLoading ? 'opacity-50 pointer-events-none' : ''}`}>
                  <Camera size={18} /> 성적표 스캔
                  <input type="file" onChange={handleScan} accept="image/*" className="hidden" disabled={isLoading} />
                </label>
                <button onClick={addSubjectRow} className="bg-slate-100 text-slate-600 px-6 py-4 rounded-2xl text-sm font-black hover:bg-slate-200 transition-all">
                  추가
                </button>
              </div>

              {isLoading && (
                <div className="mb-6 p-4 bg-indigo-50 rounded-2xl border border-indigo-100 flex items-center gap-4 animate-pulse">
                  <Loader2 className="animate-spin text-indigo-600" />
                  <span className="text-xs font-black text-indigo-700 uppercase">AI 분석 엔진 가동 중...</span>
                </div>
              )}

              <div className="space-y-3 mb-8 max-h-[400px] overflow-y-auto pr-2 scrollbar-hide">
                {subjects.map((sub, idx) => (
                  <div key={sub.id} className="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3 group relative">
                    <div className="flex items-center gap-2">
                      <input value={sub.name} onChange={e => {
                        const newSubs = [...subjects];
                        newSubs[idx].name = e.target.value;
                        setSubjects(newSubs);
                      }} className="bg-transparent border-none font-black text-sm outline-none flex-1" placeholder="과목명" />
                      <button onClick={() => setSubjects(subjects.filter(s => s.id !== sub.id))} className="text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-all">
                        <Trash2 size={16} />
                      </button>
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                      <select value={sub.achieve} onChange={e => {
                        const newSubs = [...subjects];
                        newSubs[idx].achieve = e.target.value;
                        setSubjects(newSubs);
                      }} className="bg-white rounded-xl px-2 py-2 text-xs font-bold border-none shadow-sm">
                        {['A', 'B', 'C', 'D', 'E'].map(v => <option key={v} value={v}>{v}</option>)}
                      </select>
                      <input type="number" value={sub.rank} onChange={e => {
                        const newSubs = [...subjects];
                        newSubs[idx].rank = e.target.value;
                        setSubjects(newSubs);
                      }} placeholder="석차" className="bg-white rounded-xl px-2 py-2 text-xs font-bold border-none shadow-sm" />
                      <input type="number" value={sub.total} onChange={e => {
                        const newSubs = [...subjects];
                        newSubs[idx].total = e.target.value;
                        setSubjects(newSubs);
                      }} placeholder="총원" className="bg-white rounded-xl px-2 py-2 text-xs font-bold border-none shadow-sm" />
                    </div>
                  </div>
                ))}
              </div>

              <button onClick={calculate} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-base hover:bg-slate-800 transition-all shadow-xl">
                전략 분석 결과 보기
              </button>
            </div>

            <div className="bg-white rounded-[2rem] p-6 shadow-lg border border-slate-100">
              <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">최근 분석 기록</h3>
              <div className="space-y-3">
                {history.length === 0 ? (
                  <p className="text-center py-4 text-xs font-bold text-slate-300 italic">저장된 기록이 없습니다.</p>
                ) : (
                  history.map(item => (
                    <div key={item.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 group cursor-pointer hover:border-indigo-300 transition-all">
                      <div>
                        <p className="text-[10px] font-black text-indigo-500 uppercase">{item.gradeLevel === '3' ? '고등 9등급' : '개정 5등급'}</p>
                        <p className="text-xs font-bold text-slate-800">{item.studentName || '학생'} <span className="text-indigo-600">({item.avgGrade}등급)</span></p>
                      </div>
                      <ChevronRight size={16} className="text-slate-300" />
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>

          {/* Right Column: Results */}
          <div className="lg:col-span-7">
            {!analysis ? (
              <div className="h-full min-h-[600px] bg-white rounded-[3rem] border-2 border-dashed border-slate-200 flex flex-col items-center justify-center p-12 text-center text-slate-400">
                <Calculator size={48} className="mb-4 opacity-20" />
                <h3 className="text-xl font-black text-slate-800 mb-2">분석 대기 중</h3>
                <p className="text-sm font-medium">입력 후 분석 버튼을 누르면 대시보드가 활성화됩니다.</p>
              </div>
            ) : (
              <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-[3rem] p-10 text-white shadow-2xl relative overflow-hidden">
                  <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-20 -mt-20 blur-3xl"></div>
                  <div className="relative z-10">
                    <p className="text-[10px] font-black uppercase tracking-widest opacity-70 mb-2">Total Grade Average</p>
                    <div className="flex items-baseline gap-3 mb-6">
                      <span className="text-8xl font-black tracking-tighter">{analysis.avg}</span>
                      <span className="text-xl font-bold opacity-60">등급</span>
                    </div>
                    <div className="bg-black/20 backdrop-blur-md rounded-2xl p-5 border border-white/10">
                      <div className="flex items-center gap-2 mb-2">
                        <AlertCircle size={14} className="text-yellow-400" />
                        <span className="text-xs font-black uppercase">AI 전략 분석</span>
                      </div>
                      <p className="text-sm font-medium leading-relaxed">
                        {analysis.subjects.find(s => s.target) 
                          ? <b>{analysis.subjects.find(s => s.target).name}</b> 
                          : "전 과목"}의 성적이 매우 우수합니다. 현재의 학습 밸런스를 유지하는 데 집중하세요.
                      </p>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {analysis.subjects.map((s, idx) => (
                    <div key={idx} className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm hover:shadow-md transition-all">
                      <div className="flex justify-between items-start mb-4">
                        <h5 className="text-lg font-black text-slate-800">{s.name}</h5>
                        <div className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-xl font-black text-xs">
                          {s.grade}등급
                        </div>
                      </div>
                      <div className="space-y-3">
                        <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                          <span>상위 {(s.ratio * 100).toFixed(1)}%</span>
                          <span>{s.rank} / {s.total}</span>
                        </div>
                        <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                          <div className="bg-indigo-600 h-full transition-all duration-1000" style={{ width: `${100 - (s.ratio * 100)}%` }}></div>
                        </div>
                        {s.target && (
                          <div className="mt-4 pt-4 border-t border-dashed border-slate-100">
                            <p className="text-[10px] font-black text-indigo-600 mb-1 uppercase tracking-tighter">Next Goal: {s.target.grade}등급</p>
                            <p className="text-xs text-slate-500 font-medium leading-tight">약 <span className="text-indigo-600 font-black">{s.target.diff}명</span>을 추월하면 등급이 상승합니다.</p>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </main>

      {/* Toast Notification */}
      {modal.show && (
        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-2">
          <div className={`bg-white rounded-2xl p-4 shadow-2xl border flex items-center gap-3 min-w-[300px] border-${modal.theme}-100`}>
            {modal.theme === 'emerald' ? <CheckCircle2 className="text-emerald-500" /> : <AlertCircle className="text-indigo-500" />}
            <div>
              <p className="text-sm font-black text-slate-800">{modal.title}</p>
              <p className="text-xs text-slate-500 font-medium">{modal.desc}</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
