<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Strategy Pro - Ready to Use</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen text-slate-900">
    <div class="max-w-6xl mx-auto p-5 md:p-8">
        <!-- 상단 헤더 섹션 -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <span class="text-indigo-600 font-bold tracking-tight text-sm uppercase">Academic Performance Tracker</span>
                <h1 class="text-3xl font-extrabold tracking-tight mt-1">성적 분석 & 향상 전략</h1>
                <p class="text-xs text-slate-500 mt-1" id="system-notice">* API 키를 입력해야 사진 분석이 가능합니다.</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <!-- API 키 입력 필드 추가 (보안을 위해 깃허브 소스에는 안 남도록 처리) -->
                <input type="password" id="user-api-key" placeholder="Gemini API Key 입력" class="text-xs border border-slate-200 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                
                <button onclick="resetApp()" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all">
                    새로고침
                </button>
                <label class="cursor-pointer bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 px-5 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-sm flex items-center gap-2">
                    성적표 스캔 (OCR)
                    <input type="file" id="multi-upload" accept="image/*" multiple class="hidden" onchange="handleMultipleImages(event)">
                </label>
                <button onclick="calculateStrategy()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-lg">
                    분석 실행
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- 좌측: 설정 및 입력 영역 -->
            <div class="lg:col-span-4 space-y-6">
                <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h2 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">학생 및 학기 정보</h2>
                    <div class="space-y-4">
                        <input type="text" id="school-name" placeholder="학교명" class="w-full bg-slate-50 border-none rounded-xl p-3 outline-none">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="student-name" placeholder="학생 이름" class="w-full bg-slate-50 border-none rounded-xl p-3 outline-none">
                            <select id="student-grade-level" onchange="updateSystemNotice()" class="w-full bg-slate-50 border-none rounded-xl p-3 outline-none">
                                <option value="1">1학년 (5등급제)</option>
                                <option value="2">2학년 (5등급제)</option>
                                <option value="3" selected>3학년 (9등급제)</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- 과목 입력 리스트 -->
                <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">과목별 성적</h2>
                        <button onclick="addSubject()" class="text-indigo-600 text-xs font-bold">+ 추가</button>
                    </div>
                    <div id="ai-loading" class="hidden mb-4 p-4 bg-indigo-50 rounded-xl flex items-center gap-3">
                        <div class="loading-spinner"></div>
                        <span class="text-xs font-semibold text-indigo-700 italic">성적표 분석 중...</span>
                    </div>
                    <div id="subject-list" class="space-y-3"></div>
                </section>
            </div>

            <!-- 우측: 분석 결과 영역 -->
            <div class="lg:col-span-8 space-y-6">
                <div id="empty-state" class="bg-white border-2 border-dashed border-slate-200 rounded-3xl h-[400px] flex flex-col items-center justify-center text-slate-400 text-center p-6">
                    <p class="font-bold text-slate-500 text-lg">데이터 분석 대기 중</p>
                </div>
                <div id="analysis-dashboard" class="hidden space-y-4 animate-fade-in">
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center">
                        <div>
                            <p class="text-xs font-bold text-indigo-400 uppercase">평균 등급</p>
                            <p class="text-4xl font-black text-indigo-600" id="curr-avg-grade">-</p>
                        </div>
                        <p class="text-xl font-bold text-slate-700" id="mode-display"></p>
                    </div>
                    <div id="result-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 이 버전은 Firebase 없이 로컬/깃허브 페이지에서 OCR 동작 확인용으로 최적화됨
        const system9 = [0.04, 0.11, 0.23, 0.40, 0.60, 0.77, 0.89, 0.96, 1.00];
        const system5 = [0.10, 0.34, 0.66, 0.90, 1.00];

        window.updateSystemNotice = () => {
            const gl = parseInt(document.getElementById('student-grade-level').value);
            const is5 = gl < 3;
            document.getElementById('system-notice').innerText = `* 현재 [${is5 ? '5등급제' : '9등급제'}] 시스템이 적용됩니다.`;
        };

        window.addSubjectWithValue = (n='', a='A', r='', t='') => {
            const list = document.getElementById('subject-list');
            const div = document.createElement('div');
            div.className = 'bg-slate-50 p-4 rounded-xl border border-slate-100 relative group animate-fade-in';
            div.innerHTML = `
                <input type="text" value="${n}" class="subject-name font-bold text-slate-800 bg-transparent w-full mb-1 outline-none" placeholder="과목명">
                <div class="grid grid-cols-3 gap-2">
                    <select class="subject-achievement text-[10px] p-2 rounded-lg border-none"><option value="A">A</option><option value="B">B</option><option value="C">C</option></select>
                    <input type="number" value="${r}" class="current-rank text-[10px] p-2 rounded-lg border-none" placeholder="등수">
                    <input type="number" value="${t}" class="total-students text-[10px] p-2 rounded-lg border-none" placeholder="총원">
                </div>
                <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-slate-300 hover:text-red-400">×</button>
            `;
            list.appendChild(div);
        };
        window.addSubject = () => addSubjectWithValue();

        window.calculateStrategy = () => {
            const rows = document.querySelectorAll('#subject-list > div');
            const gl = parseInt(document.getElementById('student-grade-level').value);
            const cutoffs = gl < 3 ? system5 : system9;
            const sysName = gl < 3 ? "5등급제" : "9등급제";
            
            let sum = 0, count = 0;
            const container = document.getElementById('result-container');
            container.innerHTML = '';

            rows.forEach(row => {
                const n = row.querySelector('.subject-name').value;
                const r = parseInt(row.querySelector('.current-rank').value);
                const t = parseInt(row.querySelector('.total-students').value);
                
                if (n && r && t) {
                    const ratio = r/t;
                    let g = cutoffs.length;
                    for(let i=0; i<cutoffs.length; i++) { if(ratio <= cutoffs[i]) { g = i+1; break; } }
                    sum += g; count++;
                    
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-xl border border-slate-100 shadow-sm';
                    card.innerHTML = `<h4 class="font-bold text-slate-800">${n} - ${g}등급</h4><p class="text-xs text-slate-500 mt-1">분석 완료</p>`;
                    container.appendChild(card);
                }
            });

            if (count > 0) {
                document.getElementById('curr-avg-grade').innerText = (sum/count).toFixed(2);
                document.getElementById('mode-display').innerText = sysName;
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('analysis-dashboard').classList.remove('hidden');
            }
        };

        window.handleMultipleImages = async (e) => {
            const apiKey = document.getElementById('user-api-key').value;
            if(!apiKey) return alert("상단에 Gemini API Key를 입력해주세요!");

            const files = Array.from(e.target.files);
            document.getElementById('ai-loading').classList.remove('hidden');
            
            for (let f of files) {
                const b64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(f);
                });
                await processImage(b64, apiKey);
            }
            document.getElementById('ai-loading').classList.add('hidden');
            calculateStrategy();
        };

        async function processImage(b64, key) {
            const prompt = "성적표 이미지에서 schoolName, studentName, gradeLevel(1,2,3 중 하나), subjects[{name, achievement, rank, total}]를 JSON으로 추출해줘.";
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: b64 } }] }] })
                });
                const d = await res.json();
                const text = d.candidates[0].content.parts[0].text.replace(/```json|```/g, '');
                const result = JSON.parse(text);
                
                if (result.schoolName) document.getElementById('school-name').value = result.schoolName;
                if (result.studentName) document.getElementById('student-name').value = result.studentName;
                if (result.gradeLevel) {
                    document.getElementById('student-grade-level').value = result.gradeLevel.toString().replace(/[^1-3]/g, '1');
                    updateSystemNotice();
                }
                result.subjects?.forEach(s => addSubjectWithValue(s.name, s.achievement, s.rank, s.total));
            } catch(e) { 
                console.error(e); 
                alert("인식 오류: API 키가 맞는지, 혹은 이미지 화질을 확인해주세요.");
            }
        }

        window.resetApp = () => location.reload();
        window.onload = updateSystemNotice;
    </script>
</body>
</html>
