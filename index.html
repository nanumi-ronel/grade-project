<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Strategy Pro - API Diagnostic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .api-status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-idle { background-color: #cbd5e1; }
        .status-success { background-color: #22c55e; }
        .status-error { background-color: #ef4444; }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen text-slate-900">
    <div class="max-w-6xl mx-auto p-5 md:p-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <span class="text-indigo-600 font-bold tracking-tight text-sm uppercase italic">Final Grade Solution</span>
                <h1 class="text-3xl font-extrabold tracking-tight mt-1">성적 분석 시스템</h1>
                <p class="text-xs text-slate-500 mt-1" id="system-notice">* API 키 없이 수동 입력도 가능합니다.</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <div class="relative group">
                    <input type="password" id="user-api-key" placeholder="AIza... 키를 입력하세요" class="text-xs border border-slate-200 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm w-64 pr-20">
                    <span class="absolute -top-6 left-1 text-[10px] text-indigo-400 font-bold uppercase">Gemini API Key</span>
                    <div id="api-status-badge" class="absolute right-12 top-1/2 -translate-y-1/2 flex items-center">
                        <span class="api-status-dot status-idle"></span>
                    </div>
                    <!-- Diagnostic Button -->
                    <button onclick="checkKeyStatus()" class="absolute right-2 top-1.5 bg-slate-100 hover:bg-slate-200 text-[10px] px-2 py-1 rounded-lg font-bold text-slate-500 transition-all">확인</button>
                </div>
                
                <button onclick="resetApp()" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all">초기화</button>
                
                <label class="cursor-pointer bg-indigo-50 border border-indigo-100 hover:bg-indigo-100 text-indigo-700 px-5 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-sm flex items-center gap-2">
                    성적표 사진 분석
                    <input type="file" id="multi-upload" accept="image/*" multiple class="hidden" onchange="handleMultipleImages(event)">
                </label>
                
                <button onclick="calculateStrategy()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-lg">결과 계산</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left Panel -->
            <div class="lg:col-span-4 space-y-6">
                <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <h2 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">기본 정보</h2>
                    <div class="space-y-4">
                        <input type="text" id="school-name" placeholder="학교명 (자동 추출)" class="w-full bg-slate-50 border-none rounded-xl p-3 outline-none text-sm focus:ring-1 focus:ring-indigo-300">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="student-name" placeholder="학생 이름" class="w-full bg-slate-50 border-none rounded-xl p-3 outline-none text-sm focus:ring-1 focus:ring-indigo-300">
                            <select id="student-grade-level" onchange="updateSystemNotice()" class="w-full bg-slate-50 border-none rounded-xl p-3 outline-none text-sm focus:ring-1 focus:ring-indigo-300">
                                <option value="1">1학년 (5등급제)</option>
                                <option value="2">2학년 (5등급제)</option>
                                <option value="3" selected>3학년 (9등급제)</option>
                            </select>
                        </div>
                    </div>
                </section>

                <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">과목별 성적</h2>
                        <button onclick="addSubject()" class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-indigo-100">+ 과목 추가</button>
                    </div>
                    <div id="ai-loading" class="hidden mb-4 p-4 bg-indigo-50 rounded-xl flex items-center gap-3">
                        <div class="loading-spinner"></div>
                        <span class="text-xs font-semibold text-indigo-700 italic">데이터 추출 중...</span>
                    </div>
                    <div id="subject-list" class="space-y-3"></div>
                </section>
            </div>

            <!-- Right Panel -->
            <div class="lg:col-span-8 space-y-6">
                <div id="empty-state" class="bg-white border-2 border-dashed border-slate-200 rounded-3xl h-[450px] flex flex-col items-center justify-center text-slate-400 text-center p-6">
                    <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <p class="font-bold text-slate-500 text-lg">데이터 입력 대기 중</p>
                    <p class="text-sm mt-2 max-w-xs">왼쪽 과목 리스트에 등수와 총원을 입력하거나,<br>성적표 사진을 올려주세요.</p>
                </div>

                <div id="analysis-dashboard" class="hidden space-y-4 animate-fade-in">
                    <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <div>
                            <p class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-1">Total Average</p>
                            <div class="flex items-baseline gap-2">
                                <span class="text-5xl font-black text-slate-900" id="curr-avg-grade">0.00</span>
                                <span class="text-lg font-bold text-indigo-600">등급</span>
                            </div>
                        </div>
                        <div class="h-12 w-px bg-slate-100 hidden md:block"></div>
                        <div class="text-right">
                            <p class="text-xs font-bold text-slate-400 uppercase mb-1" id="mode-display-label">적용 시스템</p>
                            <p class="text-xl font-bold text-slate-700" id="mode-display">-</p>
                        </div>
                    </div>
                    <div id="result-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info/Error Modal -->
    <div id="info-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl max-w-md w-full p-8 shadow-2xl animate-fade-in">
            <div id="modal-icon" class="w-12 h-12 rounded-full flex items-center justify-center mb-4"></div>
            <h3 id="modal-title" class="text-xl font-bold text-slate-900 mb-2"></h3>
            <p id="modal-message" class="text-sm text-slate-500 mb-6 leading-relaxed font-mono bg-slate-50 p-4 rounded-xl break-all"></p>
            <button onclick="closeModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-slate-800 transition-all">확인</button>
        </div>
    </div>

    <script>
        const system9 = [0.04, 0.11, 0.23, 0.40, 0.60, 0.77, 0.89, 0.96, 1.00];
        const system5 = [0.10, 0.34, 0.66, 0.90, 1.00];

        function showModal(title, msg, isError = true) {
            const modal = document.getElementById('info-modal');
            const icon = document.getElementById('modal-icon');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = msg;
            
            if(isError) {
                icon.className = "w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mb-4";
                icon.innerHTML = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
            } else {
                icon.className = "w-12 h-12 bg-green-50 rounded-full flex items-center justify-center mb-4";
                icon.innerHTML = `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            }
            modal.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('info-modal').classList.add('hidden'); }

        function updateApiIndicator(status) {
            const dot = document.querySelector('.api-status-dot');
            dot.className = 'api-status-dot';
            if(status === 'success') dot.classList.add('status-success');
            else if(status === 'error') dot.classList.add('status-error');
            else dot.classList.add('status-idle');
        }

        async function checkKeyStatus() {
            const key = document.getElementById('user-api-key').value.trim();
            if(!key) {
                updateApiIndicator('idle');
                return showModal("키 누락", "AIza...로 시작하는 API 키를 입력해주세요.");
            }
            
            const cleanKey = key.replace(/[\s\t\n\r]/g, '');
            const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${cleanKey}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                updateApiIndicator('success');
                showModal("연결 성공", "API 키가 유효하며 정상적으로 연결되었습니다!", false);
            } catch(e) {
                updateApiIndicator('error');
                showModal("연결 실패", "API 키가 올바르지 않거나 활성화되지 않았습니다: " + e.message);
            }
        }

        window.updateSystemNotice = () => {
            const gl = parseInt(document.getElementById('student-grade-level').value);
            const is5 = gl < 3;
            document.getElementById('system-notice').innerText = `* 현재 [${is5 ? '5등급제' : '9등급제'}] 시스템이 적용됩니다.`;
        };

        window.addSubjectWithValue = (n='', a='A', r='', t='') => {
            const list = document.getElementById('subject-list');
            const div = document.createElement('div');
            div.className = 'bg-slate-50 p-4 rounded-xl border border-slate-100 relative group animate-fade-in';
            div.innerHTML = `
                <input type="text" value="${n}" class="subject-name font-bold text-slate-800 bg-transparent w-full mb-2 outline-none text-sm border-b border-transparent focus:border-indigo-200" placeholder="과목명 입력">
                <div class="grid grid-cols-3 gap-2">
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-bold text-slate-400 pl-1 uppercase">Achievement</label>
                        <select class="subject-achievement text-xs p-2 rounded-lg border-none shadow-sm outline-none bg-white">
                            <option value="A" ${a==='A'?'selected':''}>A</option>
                            <option value="B" ${a==='B'?'selected':''}>B</option>
                            <option value="C" ${a==='C'?'selected':''}>C</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-bold text-slate-400 pl-1 uppercase">Rank</label>
                        <input type="number" value="${r}" class="current-rank text-xs p-2 rounded-lg border-none shadow-sm outline-none bg-white" placeholder="등수">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-bold text-slate-400 pl-1 uppercase">Total</label>
                        <input type="number" value="${t}" class="total-students text-xs p-2 rounded-lg border-none shadow-sm outline-none bg-white" placeholder="총원">
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-slate-300 hover:text-red-400 transition-colors">×</button>
            `;
            list.appendChild(div);
        };

        window.addSubject = () => addSubjectWithValue();

        window.calculateStrategy = () => {
            const rows = document.querySelectorAll('#subject-list > div');
            const gl = parseInt(document.getElementById('student-grade-level').value);
            const cutoffs = gl < 3 ? system5 : system9;
            const sysName = gl < 3 ? "2025 개정 (5등급제)" : "기존 체제 (9등급제)";
            
            let sum = 0, count = 0;
            const container = document.getElementById('result-container');
            container.innerHTML = '';

            rows.forEach(row => {
                const n = row.querySelector('.subject-name').value;
                const r = parseInt(row.querySelector('.current-rank').value);
                const t = parseInt(row.querySelector('.total-students').value);
                
                if (n && r && t) {
                    const ratio = r/t;
                    let g = cutoffs.length;
                    for(let i=0; i<cutoffs.length; i++) { if(ratio <= cutoffs[i]) { g = i+1; break; } }
                    sum += g; count++;
                    
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-2xl border border-slate-100 shadow-sm animate-fade-in border-l-4 border-l-indigo-500 hover:shadow-md transition-shadow';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-slate-800">${n}</h4>
                            <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded-md font-bold uppercase">${(ratio*100).toFixed(1)}% 상위</span>
                        </div>
                        <p class="text-3xl font-black text-slate-900 mt-2">${g}<span class="text-sm font-normal text-slate-400 ml-1">등급</span></p>
                    `;
                    container.appendChild(card);
                }
            });

            if (count > 0) {
                document.getElementById('curr-avg-grade').innerText = (sum/count).toFixed(2);
                document.getElementById('mode-display').innerText = sysName;
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('analysis-dashboard').classList.remove('hidden');
                document.getElementById('analysis-dashboard').scrollIntoView({ behavior: 'smooth' });
            } else {
                showModal("입력 부족", "결과를 계산하려면 최소 1개 이상의 과목에 대해 [과목명, 등수, 총원]을 모두 입력해야 합니다.");
            }
        };

        window.handleMultipleImages = async (e) => {
            const apiKeyInput = document.getElementById('user-api-key').value.trim();
            if(!apiKeyInput) return showModal("키 필요", "분석을 위해 상단의 Gemini API Key를 먼저 입력해주세요.");

            const files = Array.from(e.target.files);
            document.getElementById('ai-loading').classList.remove('hidden');
            
            for (let f of files) {
                try {
                    const b64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(f);
                    });
                    await processImage(b64, apiKeyInput);
                } catch (err) {
                    console.error(err);
                }
            }
            document.getElementById('ai-loading').classList.add('hidden');
            showModal("추출 완료", "이미지에서 가능한 데이터를 모두 가져왔습니다. 부족한 부분은 수동으로 채워주세요.", false);
        };

        async function processImage(b64, key) {
            const cleanKey = key.replace(/[\s\t\n\r]/g, '');
            // 프롬프트 보강: 데이터가 없어도 구조를 유지하게 함
            const prompt = `성적표 이미지에서 학교명(schoolName), 이름(studentName), 학년(gradeLevel), 과목 리스트(subjects: {name, achievement, rank, total})를 JSON으로 추출해줘. 
            이미지에서 명확하지 않은 값은 모두 빈 문자열("")로 처리하고, 과목이 전혀 보이지 않아도 subjects 리스트에 최소 5개의 빈 객체({})를 넣어줘. 
            반드시 JSON 형식으로만 응답해.`;
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${cleanKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: b64 } }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                let text = data.candidates[0].content.parts[0].text;
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    // JSON 추출 실패 시에도 빈 칸 5개 추가
                    for(let i=0; i<5; i++) addSubject();
                    return;
                }
                
                const result = JSON.parse(jsonMatch[0]);
                if (result.schoolName) document.getElementById('school-name').value = result.schoolName;
                if (result.studentName) document.getElementById('student-name').value = result.studentName;
                
                if (!result.subjects || result.subjects.length === 0) {
                    for(let i=0; i<5; i++) addSubject();
                } else {
                    result.subjects.forEach(s => addSubjectWithValue(s.name || '', s.achievement || 'A', s.rank || '', s.total || ''));
                    // 인식된 과목이 너무 적으면 빈 칸을 더 추가해줌
                    if(result.subjects.length < 3) for(let i=0; i<3; i++) addSubject();
                }
                updateApiIndicator('success');
            } catch(e) { 
                updateApiIndicator('error');
                // 에러 발생 시에도 빈 칸 추가하여 사용자가 입력할 수 있게 배려
                for(let i=0; i<5; i++) addSubject();
                showModal("인식 제한", "이미지에서 텍스트를 읽는 데 한계가 있어 빈 입력창을 생성했습니다. 직접 입력해 주세요.");
            }
        }

        window.resetApp = () => location.reload();
        window.onload = () => {
            updateSystemNotice();
            // 초기 로딩 시 빈 칸 3개 기본 제공
            for(let i=0; i<3; i++) addSubject();
        };
    </script>
</body>
</html>
